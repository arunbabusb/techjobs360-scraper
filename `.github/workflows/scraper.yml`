import requests
import json
import time
import hashlib
from datetime import datetime
import os

class JobScraper:
    def __init__(self):
        # WordPress credentials from environment variables
        self.wp_url = os.getenv('WP_URL', 'https://techjobs360.com')
        self.wp_user = os.getenv('WP_USERNAME')
        self.wp_password = os.getenv('WP_APP_PASSWORD')
        
        # API Keys from environment variables
        self.adzuna_app_id = os.getenv('ADZUNA_APP_ID', '6e27536a')
        self.adzuna_api_key = os.getenv('ADZUNA_API_KEY', '4e216b84d2a29d5a815a765fde36ad61')
        self.jsearch_api_key = os.getenv('JSEARCH_API_KEY')
        
        # Track posted jobs to avoid duplicates
        self.posted_jobs_file = 'posted_jobs.json'
        self.posted_jobs = self.load_posted_jobs()
    
    def load_posted_jobs(self):
        """Load previously posted job IDs"""
        try:
            with open(self.posted_jobs_file, 'r') as f:
                return json.load(f)
        except FileNotFoundError:
            return []
    
    def save_posted_jobs(self):
        """Save posted job IDs"""
        with open(self.posted_jobs_file, 'w') as f:
            json.dump(self.posted_jobs[-1000:], f)  # Keep last 1000 jobs
    
    def generate_job_id(self, job):
        """Generate unique ID for job to prevent duplicates"""
        unique_string = f"{job['title']}{job['company']}{job['location']}"
        return hashlib.md5(unique_string.encode()).hexdigest()
    
    def fetch_adzuna_jobs(self, country='in', query='software engineer', location=''):
        """Fetch jobs from Adzuna API - FREE tier 1000 calls/month"""
        if not self.adzuna_app_id or not self.adzuna_api_key:
            print("‚ö†Ô∏è Adzuna API credentials not set")
            return []
        
        url = f"https://api.adzuna.com/v1/api/jobs/{country}/search/1"
        params = {
            'app_id': self.adzuna_app_id,
            'app_key': self.adzuna_api_key,
            'results_per_page': 20,
            'what': query,
            'where': location,
            'sort_by': 'date'
        }
        
        try:
            response = requests.get(url, params=params, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            jobs = []
            for job in data.get('results', []):
                salary_text = ''
                if job.get('salary_min') and job.get('salary_max'):
                    salary_text = f"${job['salary_min']:,.0f} - ${job['salary_max']:,.0f}"
                elif job.get('salary_max'):
                    salary_text = f"Up to ${job['salary_max']:,.0f}"
                
                jobs.append({
                    'title': job.get('title', 'No Title'),
                    'company': job.get('company', {}).get('display_name', 'Unknown Company'),
                    'location': job.get('location', {}).get('display_name', location),
                    'description': job.get('description', 'No description available'),
                    'url': job.get('redirect_url', ''),
                    'salary': salary_text,
                    'posted_date': job.get('created', datetime.now().isoformat()),
                    'source': 'Adzuna',
                    'job_type': job.get('contract_time', 'Full-time')
                })
            
            print(f"‚úÖ Fetched {len(jobs)} jobs from Adzuna ({country} - {query})")
            return jobs
        
        except Exception as e:
            print(f"‚ùå Error fetching Adzuna jobs: {e}")
            return []
    
    def fetch_jsearch_jobs(self, query='Software Engineer', location='India', num_pages=1):
        """Fetch jobs from JSearch API - FREE tier 2500 requests/month"""
        if not self.jsearch_api_key:
            print("‚ö†Ô∏è JSearch API key not set - skipping JSearch")
            return []
        
        url = "https://jsearch.p.rapidapi.com/search"
        headers = {
            "X-RapidAPI-Key": self.jsearch_api_key,
            "X-RapidAPI-Host": "jsearch.p.rapidapi.com"
        }
        
        jobs = []
        
        try:
            for page in range(1, num_pages + 1):
                params = {
                    "query": f"{query} in {location}",
                    "page": str(page),
                    "num_pages": "1",
                    "date_posted": "week"  # Only jobs from last week
                }
                
                response = requests.get(url, headers=headers, params=params, timeout=15)
                response.raise_for_status()
                data = response.json()
                
                for job in data.get('data', []):
                    # Extract salary info
                    salary_text = ''
                    if job.get('job_min_salary') and job.get('job_max_salary'):
                        salary_text = f"${job['job_min_salary']:,.0f} - ${job['job_max_salary']:,.0f}"
                    
                    jobs.append({
                        'title': job.get('job_title', 'No Title'),
                        'company': job.get('employer_name', 'Unknown Company'),
                        'location': job.get('job_city', location) or job.get('job_country', location),
                        'description': job.get('job_description', 'No description available')[:1000],
                        'url': job.get('job_apply_link', job.get('job_google_link', '')),
                        'salary': salary_text,
                        'posted_date': job.get('job_posted_at_datetime_utc', datetime.now().isoformat()),
                        'source': 'JSearch',
                        'job_type': job.get('job_employment_type', 'Full-time')
                    })
                
                time.sleep(1)  # Rate limiting between pages
            
            print(f"‚úÖ Fetched {len(jobs)} jobs from JSearch ({query} in {location})")
            return jobs
        
        except Exception as e:
            print(f"‚ùå Error fetching JSearch jobs: {e}")
            return []
    
    def fetch_remotive_jobs(self):
        """Fetch remote jobs from Remotive API - 100% FREE"""
        url = "https://remotive.com/api/remote-jobs"
        
        try:
            response = requests.get(url, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            jobs = []
            for job in data.get('jobs', [])[:20]:  # Get latest 20
                # Filter for tech/engineering jobs
                category = job.get('category', '').lower()
                title = job.get('title', '').lower()
                
                if any(keyword in category or keyword in title for keyword in 
                       ['software', 'dev', 'engineer', 'programmer', 'tech', 'data']):
                    
                    jobs.append({
                        'title': job.get('title', 'No Title'),
                        'company': job.get('company_name', 'Unknown Company'),
                        'location': 'Remote (Worldwide)',
                        'description': job.get('description', 'No description available')[:1000],
                        'url': job.get('url', ''),
                        'salary': job.get('salary', ''),
                        'posted_date': job.get('publication_date', datetime.now().isoformat()),
                        'source': 'Remotive',
                        'job_type': job.get('job_type', 'Full-time')
                    })
            
            print(f"‚úÖ Fetched {len(jobs)} remote jobs from Remotive")
            return jobs
        
        except Exception as e:
            print(f"‚ùå Error fetching Remotive jobs: {e}")
            return []
    
    def fetch_arbeitnow_jobs(self):
        """Fetch jobs from Arbeitnow API - 100% FREE"""
        url = "https://www.arbeitnow.com/api/job-board-api"
        
        try:
            response = requests.get(url, timeout=10)
            response.raise_for_status()
            data = response.json()
            
            jobs = []
            for job in data.get('data', [])[:15]:
                jobs.append({
                    'title': job.get('title', 'No Title'),
                    'company': job.get('company_name', 'Unknown Company'),
                    'location': job.get('location', 'Remote'),
                    'description': job.get('description', 'No description available')[:1000],
                    'url': job.get('url', ''),
                    'salary': '',
                    'posted_date': job.get('created_at', datetime.now().isoformat()),
                    'source': 'Arbeitnow',
                    'job_type': 'Full-time'
                })
            
            print(f"‚úÖ Fetched {len(jobs)} jobs from Arbeitnow")
            return jobs
        
        except Exception as e:
            print(f"‚ùå Error fetching Arbeitnow jobs: {e}")
            return []
    
    def post_to_wordpress(self, job):
        """Post job to WordPress via REST API"""
        if not self.wp_user or not self.wp_password:
            print("‚ö†Ô∏è WordPress credentials not set")
            return False
        
        # Check if already posted
        job_id = self.generate_job_id(job)
        if job_id in self.posted_jobs:
            print(f"‚è≠Ô∏è Skipping duplicate: {job['title']} at {job['company']}")
            return False
        
        # Clean and format description
        description = job['description'].replace('\n', '<br>')
        if len(description) > 1500:
            description = description[:1500] + '...'
        
        # Prepare post content with better formatting
        content = f"""
<div class="job-listing" style="font-family: Arial, sans-serif; line-height: 1.6;">
    <div class="job-header" style="border-bottom: 2px solid #0066cc; padding-bottom: 15px; margin-bottom: 20px;">
        <h2 style="color: #0066cc; margin: 0 0 10px 0;">{job['title']}</h2>
        <p style="font-size: 18px; color: #333; margin: 5px 0;">
            <strong>üè¢ Company:</strong> {job['company']}
        </p>
        <p style="font-size: 16px; color: #666; margin: 5px 0;">
            <strong>üìç Location:</strong> {job['location']}
        </p>
        {f'<p style="font-size: 16px; color: #28a745; margin: 5px 0;"><strong>üí∞ Salary:</strong> {job["salary"]}</p>' if job['salary'] else ''}
        {f'<p style="font-size: 14px; color: #666; margin: 5px 0;"><strong>‚è∞ Job Type:</strong> {job["job_type"]}</p>' if job.get('job_type') else ''}
    </div>
    
    <div class="job-description" style="margin: 20px 0; color: #444;">
        <h3 style="color: #333;">Job Description</h3>
        <p>{description}</p>
    </div>
    
    <div class="job-apply" style="margin: 30px 0; text-align: center;">
        <a href="{job['url']}" target="_blank" rel="nofollow" 
           style="display: inline-block; background-color: #0066cc; color: white; 
                  padding: 15px 40px; text-decoration: none; border-radius: 5px; 
                  font-size: 18px; font-weight: bold;">
            Apply for this Job ‚Üí
        </a>
    </div>
    
    <div class="job-meta" style="border-top: 1px solid #ddd; padding-top: 15px; 
                                 margin-top: 20px; font-size: 12px; color: #999;">
        <p>üìå Source: {job['source']} | üìÖ Posted: {job['posted_date'][:10]}</p>
    </div>
</div>
        """
        
        # Extract location for tags
        location_tag = job['location'].split(',')[0].strip()
        
        # Create WordPress post
        post_data = {
            'title': f"{job['title']} at {job['company']} - {location_tag}",
            'content': content,
            'status': 'publish',
            'categories': [1],  # Adjust category ID as needed
            'tags': [location_tag, job['company'], job['source'], 'tech-jobs', 'engineering-jobs'],
            'meta': {
                'job_location': job['location'],
                'job_company': job['company'],
                'job_url': job['url'],
                'job_source': job['source'],
                'job_salary': job.get('salary', ''),
                'job_type': job.get('job_type', '')
            }
        }
        
        try:
            response = requests.post(
                f"{self.wp_url}/wp-json/wp/v2/posts",
                json=post_data,
                auth=(self.wp_user, self.wp_password),
                timeout=15
            )
            
            if response.status_code == 201:
                self.posted_jobs.append(job_id)
                print(f"‚úÖ Posted: {job['title']} at {job['company']} ({job['location']})")
                return True
            else:
                print(f"‚ùå Failed to post: {response.status_code} - {response.text[:200]}")
                return False
        
        except Exception as e:
            print(f"‚ùå Error posting to WordPress: {e}")
            return False
    
    def run(self):
        """Main execution function"""
        print(f"\nüöÄ Starting job scraping at {datetime.now()}")
        print("=" * 70)
        
        all_jobs = []
        
        # Fetch from multiple sources
        print("\nüì• Fetching jobs from multiple APIs...")
        print("-" * 70)
        
        # INDIA JOBS - Major Tech Cities
        print("\nüáÆüá≥ Fetching India Jobs...")
        all_jobs.extend(self.fetch_adzuna_jobs(country='in', query='software engineer', location='Bangalore'))
        all_jobs.extend(self.fetch_adzuna_jobs(country='in', query='data engineer', location='Hyderabad'))
        all_jobs.extend(self.fetch_adzuna_jobs(country='in', query='python developer', location='Pune'))
        all_jobs.extend(self.fetch_adzuna_jobs(country='in', query='frontend developer', location='Mumbai'))
        
        # JSearch for India
        if self.jsearch_api_key:
            all_jobs.extend(self.fetch_jsearch_jobs(query='Software Engineer', location='Bangalore India', num_pages=1))
            all_jobs.extend(self.fetch_jsearch_jobs(query='Data Scientist', location='India', num_pages=1))
        
        # USA JOBS - Major Tech Hubs
        print("\nüá∫üá∏ Fetching USA Jobs...")
        all_jobs.extend(self.fetch_adzuna_jobs(country='us', query='software engineer', location='San Francisco'))
        all_jobs.extend(self.fetch_adzuna_jobs(country='us', query='full stack developer', location='Austin'))
        all_jobs.extend(self.fetch_adzuna_jobs(country='us', query='devops engineer', location='Seattle'))
        
        # JSearch for USA
        if self.jsearch_api_key:
            all_jobs.extend(self.fetch_jsearch_jobs(query='Software Engineer', location='San Francisco', num_pages=1))
            all_jobs.extend(self.fetch_jsearch_jobs(query='Python Developer', location='New York', num_pages=1))
        
        # REMOTE JOBS (Global)
        print("\nüåç Fetching Remote & Global Jobs...")
        all_jobs.extend(self.fetch_remotive_jobs())
        all_jobs.extend(self.fetch_arbeitnow_jobs())
        
        print("\n" + "=" * 70)
        print(f"üìä Total jobs fetched: {len(all_jobs)}")
        
        # Post to WordPress
        print("\nüì§ Posting jobs to WordPress...")
        print("-" * 70)
        posted_count = 0
        skipped_count = 0
        
        for job in all_jobs:
            result = self.post_to_wordpress(job)
            if result:
                posted_count += 1
                time.sleep(2)  # Rate limiting - be nice to WordPress
            else:
                skipped_count += 1
        
        # Save posted jobs list
        self.save_posted_jobs()
        
        print("\n" + "=" * 70)
        print(f"‚ú® Scraping Complete!")
        print(f"   ‚úÖ Posted: {posted_count} new jobs")
        print(f"   ‚è≠Ô∏è Skipped: {skipped_count} duplicates")
        print(f"   üìù Total tracked: {len(self.posted_jobs)} jobs")
        print(f"‚è∞ Next run in 30 minutes")
        print("=" * 70 + "\n")

if __name__ == "__main__":
    scraper = JobScraper()
    scraper.run()
