name: Diagnose WP auth & workflow setup

on:
  workflow_dispatch:  # run manually from Actions tab

permissions:
  contents: read

jobs:
  diag:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Validate required secrets exist
        env:
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
        run: |
          if [ -z "${WP_USERNAME}" ] || [ -z "${WP_APP_PASSWORD}" ]; then
            echo "❌ Missing one or more required secrets: WP_USERNAME and/or WP_APP_PASSWORD."
            echo "Go to Settings → Secrets and variables → Actions and add them (do not paste secrets here)."
            exit 1
          fi
          echo "✅ WP_USERNAME and WP_APP_PASSWORD secrets found."

      - name: Test WordPress auth (GET /wp/v2/users/me)
        env:
          WP_BASE_URL: https://techjobs360.com
          WP_USERNAME: ${{ secrets.WP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
        run: |
          echo "Testing WordPress REST auth for user '${WP_USERNAME}' against ${WP_BASE_URL} ..."
          STATUS=$(curl --fail --silent --show-error -u "${WP_USERNAME}:${WP_APP_PASSWORD}" -o /dev/null -w "%{http_code}" "${WP_BASE_URL%/}/wp-json/wp/v2/users/me" || echo "000")
          if [ "${STATUS}" != "200" ]; then
            echo "❌ Auth test failed (HTTP ${STATUS})."
            echo " - Recreate an Application Password for the WP user and update the WP_APP_PASSWORD secret."
            echo " - Ensure WP_BASE_URL is correct and the user has permission to access REST API."
            exit 1
          fi
          echo "✅ Auth OK (HTTP 200). WordPress credentials appear valid."

      - name: Final note
        run: |
          echo "Diagnostics complete."
          echo "If auth failed, follow the messages above and re-run this workflow after fixing secrets/settings."
